LavaPack.loadBundle([[4,{"../../shared/constants/app":4423,"../../shared/constants/metametrics":4434,"../../shared/modules/browser-runtime.utils":4462,"../../shared/modules/mv3.utils":4475,"../../shared/modules/object.utils":4477,"../../test/e2e/default-fixture":4491,"./first-time-state":49,"./lib/createStreamSink":65,"./lib/ens-ipfs/setup":71,"./lib/get-first-preferred-lang-code":73,"./lib/getObjStructure":74,"./lib/local-store":77,"./lib/migrator":80,"./lib/network-store":82,"./lib/notification-manager":83,"./lib/setup-initial-state-hooks":107,"./lib/setupSentry":108,"./lib/util":119,"./metamask-controller":120,"./migrations":253,"./offscreen":254,"./platforms/extension":255,"./skip-onboarding":256,"@metamask/controller-utils":1166,"@metamask/obs-store":1565,"@metamask/utils":2255,"debounce-stream":3123,"eth-rpc-errors":3205,events:3276,"extension-port-stream":3279,loglevel:3789,"readable-stream":4188,"webextension-polyfill":4402},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.loadStateFromPersistence=le,r.setupController=ue,r.statePersistenceEvents=void 0,e("./lib/setup-initial-state-hooks");var n=L(e("events")),a=e("readable-stream"),o=L(e("debounce-stream")),s=L(e("loglevel")),i=L(e("webextension-polyfill")),l=e("@metamask/obs-store"),c=e("@metamask/utils"),u=e("@metamask/controller-utils"),d=L(e("extension-port-stream")),p=e("eth-rpc-errors"),f=e("../../shared/constants/app"),m=e("../../shared/constants/metametrics"),E=e("../../shared/modules/browser-runtime.utils"),g=e("../../shared/modules/mv3.utils"),C=e("../../shared/modules/object.utils"),T=(e("../../test/e2e/default-fixture"),L(e("./migrations"))),b=L(e("./lib/migrator")),v=L(e("./platforms/extension")),M=L(e("./lib/local-store")),S=(L(e("./lib/network-store")),e("./lib/setupSentry")),_=L(e("./lib/createStreamSink")),O=k(e("./lib/notification-manager")),N=k(e("./metamask-controller")),h=L(e("./first-time-state")),w=L(e("./lib/get-first-preferred-lang-code")),A=L(e("./lib/getObjStructure")),P=L(e("./lib/ens-ipfs/setup")),y=e("./lib/util"),I=(e("./skip-onboarding"),e("./offscreen"));function R(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(R=function(e){return e?r:t})(e)}function k(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=R(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&Object.prototype.hasOwnProperty.call(e,o)){var s=a?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}function L(e){return e&&e.__esModule?e:{default:e}}const U=new M.default;global.stateHooks.getMostRecentPersistedState=()=>U.mostRecentRetrievedState;const{sentry:j}=global;let D={...h.default};const F={[f.ENVIRONMENT_TYPE_POPUP]:!0,[f.ENVIRONMENT_TYPE_NOTIFICATION]:!0,[f.ENVIRONMENT_TYPE_FULLSCREEN]:!0},V=["trezor-connect"];s.default.setLevel("info",!1);const x=new v.default,B=new O.default;let G=0,Y=!1,K=!1;const q={},$={};let H,Q;const z={};const J=new URL("https://metamask.github.io/phishing-warning/v3.0.3/"),W=1e3,X=r.statePersistenceEvents=new n.default,{promise:Z,resolve:ee,reject:te}=(0,y.deferredPromise)(),re=async()=>{const e=await i.default.tabs.query({url:"<all_urls>",windowType:"normal"}).then((e=>((0,E.checkForLastErrorAndLog)(),e))).catch((()=>{(0,E.checkForLastErrorAndLog)()}));for(const t of e)i.default.tabs.sendMessage(t.id,{name:f.EXTENSION_MESSAGES.READY}).then((()=>{(0,E.checkForLastErrorAndLog)()})).catch((()=>{(0,E.checkForLastErrorAndLog)()}))};let ne,ae;function oe(){const e=(new Date).toISOString();i.default.storage.session.set({timestamp:e})}async function se(){try{const t=g.isManifestV3?(0,I.createOffscreen)():null,r=await le(),n=r.data,a=await(0,w.default)();let o;if(g.isManifestV3){var e;if(!1!==(null===(e=n.PreferencesController)||void 0===e?void 0:e.enableMV3TimestampSave)){const e=2e3;oe(),setInterval(oe,e)}const t=await i.default.storage.session.get(["isFirstMetaMaskControllerSetup"]);o=(null==t?void 0:t.isFirstMetaMaskControllerSetup)===undefined,await i.default.storage.session.set({isFirstMetaMaskControllerSetup:o})}ue(n,a,{},o,r.meta,t),g.isManifestV3||await async function(){let e;try{const t=new URL("https://metamask.github.io/phishing-warning/v3.0.3/");let r,n;t.hash="#extensionStartup",e=window.document.createElement("iframe"),e.setAttribute("src",t.href),e.setAttribute("sandbox","allow-scripts allow-same-origin");const a=new Promise(((e,t)=>{r=e,n=t}));e.addEventListener("load",r),window.document.body.appendChild(e),setTimeout((()=>n(new ie)),W),await a}catch(e){e instanceof ie?console.warn("Phishing warning page timeout; page not guaranteed to work offline."):console.error("Failed to initialize phishing warning page",e)}finally{e&&e.remove()}}(),await re(),s.default.info("MetaMask initialization complete."),ee()}catch(e){te(e)}}i.default.runtime.onConnect.addListener((async(...e)=>{await Z,ne(...e)})),i.default.runtime.onConnectExternal.addListener((async(...e)=>{await Z,ae(...e)}));class ie extends Error{constructor(){super("Timeout failed")}}async function le(){const e=new b.default({migrations:T.default,defaultVersion:null});if(e.on("error",console.warn),Q=await U.get()||e.generateInitialState(D),Q&&!Q.data&&(Q=e.generateInitialState(D),j.captureMessage("MetaMask - Empty vault found - unable to recover")),e.on("error",(e=>{const t=(0,A.default)(Q);j.captureException(e,{extra:{vaultStructure:t}})})),Q=await e.migrateData(Q),!Q)throw new Error("MetaMask - migrator returned undefined");if(!(0,c.isObject)(Q.meta))throw new Error(`MetaMask - migrator metadata has invalid type '${typeof Q.meta}'`);if("number"!=typeof Q.meta.version)throw new Error(`MetaMask - migrator metadata version has invalid type '${typeof Q.meta.version}'`);if(!(0,c.isObject)(Q.data))throw new Error(`MetaMask - migrator data has invalid type '${typeof Q.data}'`);return U.setMetadata(Q.meta),U.set(Q.data),Q}function ce(e,t,r){const{metaMetricsId:n}=H.metaMetricsController.state;if(!(0,y.shouldEmitDappViewedEvent)(n))return;if(!(0,c.hasProperty)(t.permissions,"eth_accounts"))return;const a=Object.keys(r.store.getState().identities).length,o=t.permissions.eth_accounts.caveats;if(o){const t=o[0].value.length;H.metaMetricsController.trackEvent({event:m.MetaMetricsEventName.DappViewed,category:m.MetaMetricsEventCategory.InpageProvider,referrer:{url:e},properties:{is_first_visit:!1,number_of_accounts:a,number_of_accounts_connected:t}})}}function ue(e,t,r,n,c,E){var T;H=new N.default({infuraProjectId:"b6bf7d3508c941499b10025c0776eaf8",showUserConfirmation:de,initState:e,initLangCode:t,platform:x,notificationManager:B,browser:i.default,getRequestAccountTabIds:()=>$,getOpenMetamaskTabsIds:()=>q,localStore:U,overrides:r,isFirstMetaMaskControllerSetup:n,currentMigrationVersion:c.version,featureFlags:{},offscreenPromise:E}),(0,P.default)({getCurrentChainId:()=>H.networkController.state.providerConfig.chainId,getIpfsGateway:H.preferencesController.getIpfsGateway.bind(H.preferencesController),getUseAddressBarEnsResolution:()=>H.preferencesController.store.getState().useAddressBarEnsResolution,provider:H.provider}),(0,a.pipeline)((0,l.storeAsStream)(H.store),(0,o.default)(1e3),(0,_.default)((async e=>{await U.set(e),X.emit("state-persisted",e)})),(e=>{s.default.error("MetaMask - Persistence pipeline failed",e)})),T=H,global.stateHooks.getSentryAppState=function(){const e=T.memStore.getState();return(0,C.maskObject)(e,S.SENTRY_BACKGROUND_STATE)};const b=()=>G>0||Boolean(Object.keys(q).length)||Y,v=(e,t)=>{if(!1===e)H.onClientClosed();else{if(t===f.ENVIRONMENT_TYPE_FULLSCREEN&&Boolean(Object.keys(q).length))return;H.onEnvironmentTypeClosed(t)}};function M(){let e="";const t=h();t&&(e=String(t)),g.isManifestV3?(i.default.action.setBadgeText({text:e}),i.default.action.setBadgeBackgroundColor({color:"#037DD6"})):(i.default.browserAction.setBadgeText({text:e}),i.default.browserAction.setBadgeBackgroundColor({color:"#037DD6"}))}function h(){let e=H.appStateController.waitingForUnlock.length+H.approvalController.getTotalApprovalCount();return H.preferencesController.getUseRequestQueue()&&(e+=H.queuedRequestController.state.queuedRequestCount),e}ne=async e=>{var t;const n=e.name;if(V.includes(e.name))return;let o=!1;const s=(0,y.getPlatform)(),l=null!==(t=e.sender)&&void 0!==t&&t.url?new URL(e.sender.url):null;if(o=s===f.PLATFORM_FIREFOX?F[n]:(null==l?void 0:l.origin)===`chrome-extension://${i.default.runtime.id}`,o){var c;const t=(null==r||null===(c=r.getPortStream)||void 0===c?void 0:c.call(r,e))||new d.default(e);if(H.isClientOpen=!0,H.setupTrustedCommunication(t,e.sender),n===f.ENVIRONMENT_TYPE_POPUP&&(G+=1,(0,a.finished)(t,(()=>{G-=1;const e=b();H.isClientOpen=e,v(e,f.ENVIRONMENT_TYPE_POPUP)}))),n===f.ENVIRONMENT_TYPE_NOTIFICATION&&(Y=!0,(0,a.finished)(t,(()=>{Y=!1;const e=b();H.isClientOpen=e,v(e,f.ENVIRONMENT_TYPE_NOTIFICATION)}))),n===f.ENVIRONMENT_TYPE_FULLSCREEN){const r=e.sender.tab.id;q[r]=!0,(0,a.finished)(t,(()=>{delete q[r];const e=b();H.isClientOpen=e,v(e,f.ENVIRONMENT_TYPE_FULLSCREEN)}))}}else if(l&&l.origin===J.origin&&l.pathname===J.pathname){var u;const t=(null==r||null===(u=r.getPortStream)||void 0===u?void 0:u.call(r,e))||new d.default(e);H.setupPhishingCommunication({connectionStream:t})}else{if(e.sender&&e.sender.tab&&e.sender.url){const t=e.sender.tab.id,r=new URL(e.sender.url),{origin:n}=r;Object.keys(z).includes(t)||(z[t]=n);const a=H.permissionController.state.subjects[n],o=a!==undefined,s="New Tab"!==e.sender.tab.title;o&&s&&ce(n,a,H.preferencesController),e.onMessage.addListener((e=>{e.data&&e.data.method===f.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS&&($[n]=t)}))}ae(e)}},ae=e=>{var t;const n=(null==r||null===(t=r.getPortStream)||void 0===t?void 0:t.call(r,e))||new d.default(e);H.setupUntrustedCommunication({connectionStream:n,sender:e.sender})},null!=r&&r.registerConnectListeners&&r.registerConnectListeners(ne,ae),M(),H.decryptMessageController.hub.on(N.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,M),H.encryptionPublicKeyController.hub.on(N.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,M),H.signatureController.hub.on(N.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,M),H.appStateController.on(N.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,M),H.controllerMessenger.subscribe(N.METAMASK_CONTROLLER_EVENTS.APPROVAL_STATE_CHANGE,M),H.controllerMessenger.subscribe(N.METAMASK_CONTROLLER_EVENTS.QUEUED_REQUEST_STATE_CHANGE,M),H.txController.initApprovals(),B.on(O.NOTIFICATION_MANAGER_EVENTS.POPUP_CLOSED,(({automaticallyClosed:e})=>{e?h()>0&&de():(H.signatureController.rejectUnapproved(m.REJECT_NOTIFICATION_CLOSE_SIG),H.decryptMessageController.rejectUnapproved(m.REJECT_NOTIFICATION_CLOSE),H.encryptionPublicKeyController.rejectUnapproved(m.REJECT_NOTIFICATION_CLOSE),Object.values(H.approvalController.state.pendingApprovals).forEach((({id:e,type:t})=>{switch(t){case u.ApprovalType.SnapDialogAlert:case u.ApprovalType.SnapDialogPrompt:H.approvalController.accept(e,null);break;case u.ApprovalType.SnapDialogConfirmation:case f.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.confirmAccountCreation:case f.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.confirmAccountRemoval:case f.SNAP_MANAGE_ACCOUNTS_CONFIRMATION_TYPES.showSnapAccountRedirect:H.approvalController.accept(e,!1);break;default:H.approvalController.reject(e,p.ethErrors.provider.userRejectedRequest())}}))),M()})),Object.values(H.snapController.state.snaps).some((e=>!e.preinstalled))&&H.snapController.updateBlockedSnaps()}async function de(){const e=await x.getActiveTabs(),t=Boolean(e.find((e=>q[e.id]))),r=e.length>0&&e[0].extData&&e[0].extData.indexOf("vivaldi_tab")>-1;if(!K&&(r||0===G)&&!t){K=!0;try{const e=H.appStateController.getCurrentPopupId();await B.showPopup((e=>H.appStateController.setCurrentPopupId(e)),e)}finally{K=!1}}}const pe=()=>{if(H)return H.metaMetricsController.updateTraits({[m.MetaMetricsUserTrait.InstallDateExt]:(new Date).toISOString().split("T")[0]}),void H.metaMetricsController.addEventBeforeMetricsOptIn({category:m.MetaMetricsEventCategory.App,event:m.MetaMetricsEventName.AppInstalled,properties:{}});setTimeout((()=>{pe()}),500)};async function fe(){Boolean(await U.get())||(pe(),x.openExtensionInBrowser()),i.default.tabs.onActivated.addListener((e=>{if(H){const{tabId:t}=e,r=z[t];if(r){const e=H.permissionController.state.subjects[r];e!==undefined&&ce(r,e,H.preferencesController)}}}))}(async function(){await fe(),se().catch(s.default.error)})()}}},{package:"$root$",file:"app/scripts/background.js"}]],[4],{});