LavaPack.loadBundle([[95,{"../../../../shared/constants/common":5826,"../../../../shared/constants/gas":5831,"../../../../shared/constants/metametrics":5836,"../../../../shared/constants/network":5839,"../../../../shared/constants/smartTransactions":5848,"../../../../shared/constants/swaps":5850,"../../../../shared/constants/time":5852,"../../../../shared/lib/fetch-with-cache":5881,"../../../../shared/lib/swaps-utils":5892,"../../../../shared/lib/transactions-controller-utils":5897,"../../../../shared/modules/Numeric":5901,"../../../../shared/modules/conversion.utils":5906,"../../../../shared/modules/string-utils":5926,"../../../../shared/modules/swaps.utils":5927,"./swaps.constants":96,"./swaps.utils":97,"@ethersproject/contracts":540,"@ethersproject/providers":578,"@metamask/base-controller":1402,"@sentry/browser":3135,"bignumber.js":4029,"human-standard-token-abi":4719,lodash:4934},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,s){Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;var a=e("@ethersproject/contracts"),r=e("@ethersproject/providers"),n=e("@metamask/base-controller"),i=e("@sentry/browser"),o=e("bignumber.js"),l=b(e("human-standard-token-abi")),u=e("lodash"),c=e("../../../../shared/constants/common"),d=e("../../../../shared/constants/gas"),p=e("../../../../shared/constants/metametrics"),h=e("../../../../shared/constants/network"),m=e("../../../../shared/constants/smartTransactions"),g=e("../../../../shared/constants/swaps"),f=e("../../../../shared/constants/time"),S=b(e("../../../../shared/lib/fetch-with-cache")),w=e("../../../../shared/lib/swaps-utils"),E=e("../../../../shared/lib/transactions-controller-utils"),T=e("../../../../shared/modules/conversion.utils"),v=e("../../../../shared/modules/Numeric"),M=e("../../../../shared/modules/string-utils"),_=e("../../../../shared/modules/swaps.utils"),I=e("./swaps.constants"),A=e("./swaps.utils");function b(e){return e&&e.__esModule?e:{default:e}}function C(e,t,s){N(e,t),t.set(e,s)}function N(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function R(e,t,s){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var a=s.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function P(e,t){return e.get(O(e,t))}function k(e,t,s){return e.set(O(e,t),s),s}function O(e,t,s){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:s;throw new TypeError("Private element is not present on this object")}const y={swapsState:{persist:!1,anonymous:!1}};var F=new WeakMap,L=new WeakMap,x=new WeakMap,G=new WeakMap,D=new WeakMap,B=new WeakMap,U=new WeakSet;class V extends n.BaseController{constructor(e,t){var s,a,r;super({name:I.controllerName,metadata:y,messenger:e.messenger,state:{swapsState:{...(0,I.getDefaultSwapsControllerState)().swapsState,swapsFeatureFlags:(null==t||null===(s=t.swapsState)||void 0===s?void 0:s.swapsFeatureFlags)||{}}}}),N(a=this,r=U),r.add(a),R(this,"getBufferedGasLimit",void 0),R(this,"resetState",void 0),R(this,"trackMetaMetricsEvent",void 0),C(this,F,void 0),C(this,L,void 0),C(this,x,null),C(this,G,void 0),C(this,D,void 0),C(this,B,void 0),R(this,"_fetchTradesInfo",w.fetchTradesInfo),R(this,"__test__updateState",(e=>{this.update((t=>({swapsState:{...t.swapsState,...e.swapsState}})))})),this.messagingSystem.registerActionHandler("SwapsController:fetchAndSetQuotes",this.fetchAndSetQuotes.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSelectedQuoteAggId",this.setSelectedQuoteAggId.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:resetSwapsState",this.resetSwapsState.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsTokens",this.setSwapsTokens.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:clearSwapsQuotes",this.clearSwapsQuotes.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setApproveTxId",this.setApproveTxId.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setTradeTxId",this.setTradeTxId.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsTxGasPrice",this.setSwapsTxGasPrice.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsTxGasLimit",this.setSwapsTxGasLimit.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsTxMaxFeePerGas",this.setSwapsTxMaxFeePerGas.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsTxMaxFeePriorityPerGas",this.setSwapsTxMaxFeePriorityPerGas.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:safeRefetchQuotes",this.safeRefetchQuotes.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:stopPollingForQuotes",this.stopPollingForQuotes.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setBackgroundSwapRouteState",this.setBackgroundSwapRouteState.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:resetPostFetchState",this.resetPostFetchState.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsErrorKey",this.setSwapsErrorKey.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setInitialGasEstimate",this.setInitialGasEstimate.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setCustomApproveTxData",this.setCustomApproveTxData.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsLiveness",this.setSwapsLiveness.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsFeatureFlags",this.setSwapsFeatureFlags.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsUserFeeLevel",this.setSwapsUserFeeLevel.bind(this)),this.messagingSystem.registerActionHandler("SwapsController:setSwapsQuotesPollingLimitEnabled",this.setSwapsQuotesPollingLimitEnabled.bind(this)),this.getBufferedGasLimit=e.getBufferedGasLimit,this.trackMetaMetricsEvent=e.trackMetaMetricsEvent,this.resetState=()=>{this.update((e=>{e.swapsState={...(0,I.getDefaultSwapsControllerState)().swapsState,swapsFeatureFlags:null==e?void 0:e.swapsState.swapsFeatureFlags}}))},k(G,this,e.getEIP1559GasFeeEstimates),k(D,this,e.getLayer1GasFee),k(F,this,0),k(L,this,0),this._fetchTradesInfo=e.fetchTradesInfo||w.fetchTradesInfo}clearSwapsQuotes(){this.update((e=>{e.swapsState.quotes={},e.swapsState.selectedAggId=null,e.swapsState.topAggId=null}))}async fetchAndSetQuotes(e,t,s=!1){var a;if(!e)return null;let r;r=(null===(a=P(B,this))||void 0===a?void 0:a.clientId)===t.networkClientId?P(B,this):O(U,this,Q).call(this,t.networkClientId);const{quotesPollingLimitEnabled:n,saveFetchedQuotes:i}=this.state.swapsState;s||k(L,this,0),P(x,this)&&clearTimeout(P(x,this)),s||this.setSwapsErrorKey("");const o=P(F,this)+1;k(F,this,o),i||this._setSaveFetchedQuotes(!0);let[l]=await Promise.all([this._fetchTradesInfo(e,{chainId:r.chainId}),this._setSwapsNetworkConfig(r)]);const{saveFetchedQuotes:c}=this.state.swapsState;if(!c)return[{},null];l=(0,u.mapValues)(l,(e=>({...e,sourceTokenInfo:null==t?void 0:t.sourceTokenInfo,destinationTokenInfo:null==t?void 0:t.destinationTokenInfo})));const d=r.chainId===h.CHAIN_IDS.OPTIMISM.toString(),p=r.chainId===h.CHAIN_IDS.BASE.toString();(d||p)&&Object.values(l).length>0&&await Promise.all(Object.values(l).map((async e=>{if(e.trade){const t=await P(D,this).call(this,{transactionParams:e.trade,networkClientId:r.clientId});e.multiLayerL1TradeFeeTotal=t}return e})));const m=Date.now();let f=!1;if(!(0,_.isSwapsDefaultTokenAddress)(e.sourceToken,r.chainId)&&Object.values(l).length){const t=await this._getERC20Allowance(e.sourceToken,e.fromAddress,r),[a]=Object.values(l);if(f=a.approvalNeeded&&(t.eq(0)||t.lt(a.sourceAmount))&&"wrappedNative"!==a.aggregator,f){if(!s&&a.approvalNeeded){const{gasLimit:e}=await this._timedoutGasReturn(a.approvalNeeded,a.aggregator);l=(0,u.mapValues)(l,(t=>t.approvalNeeded?{...t,approvalNeeded:{...t.approvalNeeded,gas:e||g.DEFAULT_ERC20_APPROVE_GAS}}:t))}}else l=(0,u.mapValues)(l,(e=>({...e,approvalNeeded:null})))}let S=null;if(f||null!=e&&e.balanceError||(l=await this._getAllQuotesWithGasEstimates(l)),0===Object.values(l).length)this.setSwapsErrorKey(g.QUOTES_NOT_AVAILABLE_ERROR);else{const e=await this.getTopQuoteWithCalculatedSavings({quotes:l});Array.isArray(e)&&(S=e[0],l=e[1])}if(P(F,this)!==o)throw new Error(g.SWAPS_FETCH_ORDER_CONFLICT);let{selectedAggId:w}=this.state.swapsState;return w&&l[w]||(w=null),this.update((s=>{s.swapsState.quotes=l,s.swapsState.fetchParams={...e,metaData:t},s.swapsState.quotesLastFetched=m,s.swapsState.selectedAggId=w,s.swapsState.topAggId=S})),n&&k(L,this,P(L,this)+1),!n||P(L,this)<I.POLL_COUNT_LIMIT+1?(this._pollForNewQuotes(),[l,S]):(this.resetPostFetchState(),this.setSwapsErrorKey(g.QUOTES_EXPIRED_ERROR),null)}async getTopQuoteWithCalculatedSavings({quotes:e,networkClientId:t}){var s;let a;if(t){const e=this.messagingSystem.call("NetworkController:getNetworkClientById",t);a=e.configuration.chainId}else{if(P(B,this)===undefined)throw new Error("There is no network set");a=P(B,this).chainId}const{marketData:r}=this._getTokenRatesState(),n=(null==r?void 0:r[a])??{},{customGasPrice:i,customMaxPriorityFeePerGas:l}=this.state.swapsState;if(0===Object.keys(e).length)return{};const p=(0,u.cloneDeep)(e),{gasFeeEstimates:h,gasEstimateType:m}=await P(G,this).call(this,{networkClientId:t});let g="0x0";if(m===d.GasEstimateTypes.feeMarket){const{high:{suggestedMaxPriorityFeePerGas:e},estimatedBaseFee:t}=h,s=(0,T.decGWEIToHexWEI)(Number(e)),a=new v.Numeric(t,10,c.EtherDenomination.GWEI).toDenomination(c.EtherDenomination.WEI);g=new v.Numeric(l||s,16).add(a).round(6).toString()}else m===d.GasEstimateTypes.legacy?g=i||(0,T.decGWEIToHexWEI)(Number(h.high)):m===d.GasEstimateTypes.ethGasPrice&&(g=i||(0,T.decGWEIToHexWEI)(Number(h.gasPrice)));let f,S="";Object.values(p).forEach((e=>{const{aggregator:t,approvalNeeded:s,averageGas:r,destinationAmount:i,destinationToken:l,destinationTokenInfo:u,gasEstimateWithRefund:d,sourceAmount:p,sourceToken:h,trade:m,fee:w,multiLayerL1TradeFeeTotal:A}=e;if(!m||!l)return;const b=(d?new o.BigNumber(d,16):new o.BigNumber(r||I.MAX_GAS_LIMIT,10)).plus((null==s?void 0:s.gas)||"0x0",16).toString(16);let C=(0,E.calcGasTotal)(b,g);null!==A&&(C=(0,T.sumHexes)(C||"0x0",A||"0x0"));const N=new v.Numeric(C,16,c.EtherDenomination.WEI).add(new v.Numeric(m.value,16,c.EtherDenomination.WEI)),R=N.toDenomination(c.EtherDenomination.ETH).round(6).value,P=(0,_.isSwapsDefaultTokenAddress)(h,a)?N.minus(new v.Numeric(p,10)).toDenomination(c.EtherDenomination.ETH).round(6).value:R,k=(0,E.calcTokenAmount)(i??"0",u.decimals),O=new o.BigNumber(100,10).minus(w,10).div(100),y=k.div(O).minus(k),F=Object.keys(n).find((e=>(0,M.isEqualCaseInsensitive)(e,l))),L=F?n[F]:null,x=(null==L?void 0:L.price)||1,G=k.times(x.toString(10),10),D=(0,_.isSwapsDefaultTokenAddress)(l,a)?1:null==L?void 0:L.price,B=D?G.minus(P,10):G;e.ethFee=P.toString(10),D&&(e.ethValueOfTokens=G.toString(10),e.overallValueOfQuote=B.toString(10),e.metaMaskFeeInEth=y.times(D.toString(10)).toString(10)),f&&!B.gt(f||0)||(S=t,f=B)}));const w=Object.keys(n).find((e=>{var t;return(0,M.isEqualCaseInsensitive)(e,null===(t=p[S])||void 0===t?void 0:t.destinationToken)})),b=w?n[w]:null;if((0,_.isSwapsDefaultTokenAddress)(null===(s=p[S])||void 0===s?void 0:s.destinationToken,a)||Boolean(null==b?void 0:b.price)){const e=p[S],{ethFee:t,metaMaskFeeInEth:s,ethValueOfTokens:a}=(0,A.getMedianEthValueQuote)(Object.values(p)),r=new o.BigNumber(e.ethValueOfTokens,10).minus(a,10).toString(10),n=new o.BigNumber(t).minus(e.ethFee,10).toString(10),i=e.metaMaskFeeInEth,l={performance:r,fee:n,total:new o.BigNumber(r).plus(n).minus(i).toString(10),metaMaskFee:i,medianMetaMaskFee:s};p[S].isBestQuote=!0,p[S].savings=l}return[S,p]}resetPostFetchState(){this.update((e=>{e.swapsState={...(0,I.getDefaultSwapsControllerState)().swapsState,tokens:e.swapsState.tokens,fetchParams:e.swapsState.fetchParams,swapsFeatureIsLive:e.swapsState.swapsFeatureIsLive,swapsQuoteRefreshTime:e.swapsState.swapsQuoteRefreshTime,swapsQuotePrefetchingRefreshTime:e.swapsState.swapsQuotePrefetchingRefreshTime,swapsFeatureFlags:e.swapsState.swapsFeatureFlags}})),P(x,this)&&clearTimeout(P(x,this))}resetSwapsState(){this.update((e=>{e.swapsState={...(0,I.getDefaultSwapsControllerState)().swapsState,swapsQuoteRefreshTime:e.swapsState.swapsQuoteRefreshTime,swapsQuotePrefetchingRefreshTime:e.swapsState.swapsQuotePrefetchingRefreshTime,swapsFeatureFlags:e.swapsState.swapsFeatureFlags}})),P(x,this)&&clearTimeout(P(x,this))}safeRefetchQuotes(){!P(x,this)&&this.state.swapsState.fetchParams&&this.fetchAndSetQuotes(this.state.swapsState.fetchParams,{...this.state.swapsState.fetchParams.metaData})}setApproveTxId(e){this.update((t=>{t.swapsState.approveTxId=e}))}setBackgroundSwapRouteState(e){this.update((t=>{t.swapsState.routeState=e}))}setCustomApproveTxData(e){this.update((t=>{t.swapsState.customApproveTxData=e}))}async setInitialGasEstimate(e){const t={...this.state.swapsState.quotes[e]},{gasLimit:s,simulationFails:a}=t.trade?await this._timedoutGasReturn(t.trade,t.aggregator):{gasLimit:null,simulationFails:!0};if(s&&!a){const e=(0,A.calculateGasEstimateWithRefund)(t.maxGas,t.estimatedRefund,s);t.gasEstimate=s,t.gasEstimateWithRefund=e}this.update((s=>{s.swapsState.quotes={...s.swapsState.quotes,[e]:t}}))}setSelectedQuoteAggId(e){this.update((t=>{t.swapsState.selectedAggId=e}))}setSwapsFeatureFlags(e){this.update((t=>{t.swapsState.swapsFeatureFlags=e}))}setSwapsErrorKey(e){this.update((t=>{t.swapsState.errorKey=e}))}setSwapsLiveness(e){const{swapsFeatureIsLive:t}=e;this.update((e=>{e.swapsState.swapsFeatureIsLive=t}))}setSwapsQuotesPollingLimitEnabled(e){this.update((t=>{t.swapsState.quotesPollingLimitEnabled=e}))}setSwapsTokens(e){this.update((t=>{t.swapsState.tokens=e}))}setSwapsTxGasLimit(e){this.update((t=>{t.swapsState.customMaxGas=e}))}setSwapsTxGasPrice(e){this.update((t=>{t.swapsState.customGasPrice=e}))}setSwapsTxMaxFeePerGas(e){this.update((t=>{t.swapsState.customMaxFeePerGas=e}))}setSwapsTxMaxFeePriorityPerGas(e){this.update((t=>{t.swapsState.customMaxPriorityFeePerGas=e}))}setSwapsUserFeeLevel(e){this.update((t=>{t.swapsState.swapsUserFeeLevel=e}))}setTradeTxId(e){this.update((t=>{t.swapsState.tradeTxId=e}))}stopPollingForQuotes(){P(x,this)&&clearTimeout(P(x,this))}async _fetchSwapsNetworkConfig(e){const t=await(0,S.default)({url:(0,w.getBaseApi)("network",e.chainId),fetchOptions:{method:"GET"},cacheOptions:{cacheRefreshTime:6e5},functionName:"_fetchSwapsNetworkConfig"}),{refreshRates:s,parameters:a={}}=t||{};if(!s||"number"!=typeof s.quotes||"number"!=typeof s.quotesPrefetching)throw new Error(`MetaMask - invalid response for refreshRates: ${t}`);return{quotes:1e3*s.quotes,quotesPrefetching:1e3*s.quotesPrefetching,stxGetTransactions:1e3*s.stxGetTransactions,stxBatchStatus:1e3*s.stxBatchStatus,stxStatusDeadline:s.stxStatusDeadline,stxMaxFeeMultiplier:a.stxMaxFeeMultiplier}}async _getAllQuotesWithGasEstimates(e){const t=await Promise.all(Object.values(e).map((async e=>{if(!e.trade)return{gasLimit:null,simulationFails:!0,aggId:e.aggregator};const{gasLimit:t,simulationFails:s}=await this._timedoutGasReturn(e.trade,e.aggregator);return{gasLimit:t,simulationFails:s,aggId:e.aggregator}}))),s={};return t.forEach((({gasLimit:t,simulationFails:a,aggId:r})=>{if(t&&!a){const a=(0,A.calculateGasEstimateWithRefund)(e[r].maxGas,e[r].estimatedRefund,t);s[r]={...e[r],gasEstimate:t,gasEstimateWithRefund:a}}else e[r].approvalNeeded&&(s[r]=e[r])})),s}async _getERC20Allowance(e,t,s){const r=new a.Contract(e,l.default,s.ethersProvider);return await r.allowance(t,g.SWAPS_CHAINID_CONTRACT_ADDRESS_MAP[s.chainId])}_getTokenRatesState(){const{marketData:e}=this.messagingSystem.call("TokenRatesController:getState");return{marketData:e}}_pollForNewQuotes(){const{swapsQuoteRefreshTime:e,swapsQuotePrefetchingRefreshTime:t,quotesPollingLimitEnabled:s}=this.state.swapsState;k(x,this,setTimeout((()=>{var e;this.fetchAndSetQuotes(this.state.swapsState.fetchParams,null===(e=this.state.swapsState.fetchParams)||void 0===e?void 0:e.metaData,!0)}),s?e:t))}_setSaveFetchedQuotes(e){this.update((t=>{t.swapsState.saveFetchedQuotes=e}))}async _setSwapsNetworkConfig(e){let t=null;try{t=await this._fetchSwapsNetworkConfig(e)}catch(e){console.error("Request for Swaps network config failed: ",e)}this.update((e=>{var s,a,r,n,i,o;e.swapsState.swapsQuoteRefreshTime=(null===(s=t)||void 0===s?void 0:s.quotes)||I.FALLBACK_QUOTE_REFRESH_TIME,e.swapsState.swapsQuotePrefetchingRefreshTime=(null===(a=t)||void 0===a?void 0:a.quotesPrefetching)||I.FALLBACK_QUOTE_REFRESH_TIME,e.swapsState.swapsStxGetTransactionsRefreshTime=(null===(r=t)||void 0===r?void 0:r.stxGetTransactions)||m.FALLBACK_SMART_TRANSACTIONS_REFRESH_TIME,e.swapsState.swapsStxBatchStatusRefreshTime=(null===(n=t)||void 0===n?void 0:n.stxBatchStatus)||m.FALLBACK_SMART_TRANSACTIONS_REFRESH_TIME,e.swapsState.swapsStxMaxFeeMultiplier=(null===(i=t)||void 0===i?void 0:i.stxMaxFeeMultiplier)||m.FALLBACK_SMART_TRANSACTIONS_MAX_FEE_MULTIPLIER,e.swapsState.swapsStxStatusDeadline=(null===(o=t)||void 0===o?void 0:o.stxStatusDeadline)||m.FALLBACK_SMART_TRANSACTIONS_DEADLINE}))}_timedoutGasReturn(e,t=""){return new Promise((s=>{let a=!1;const r=setTimeout((()=>{a=!0,this.trackMetaMetricsEvent({event:p.MetaMetricsEventName.QuoteError,category:p.MetaMetricsEventCategory.Swaps,properties:{error_type:p.MetaMetricsEventErrorType.GasTimeout,aggregator:t}}),s({gasLimit:null,simulationFails:!0})}),5*f.SECOND),n={data:e.data,from:e.from,to:e.to,value:e.value};this.getBufferedGasLimit({txParams:n},1).then((({gasLimit:e,simulationFails:t})=>{a||(clearTimeout(r),s({gasLimit:e,simulationFails:t}))})).catch((e=>{(0,i.captureException)(e,{extra:{aggregator:t}}),a||(clearTimeout(r),s({gasLimit:null,simulationFails:!0}))}))}))}}function Q(e){const t=this.messagingSystem.call("NetworkController:getNetworkClientById",e),{chainId:s}=t.configuration,a={client:t,clientId:e,chainId:s,ethersProvider:new r.Web3Provider(t.provider)};return k(B,this,a),a}s.default=V}}},{package:"$root$",file:"app/scripts/controllers/swaps/index.ts"}],[96,{"../../../../shared/constants/smartTransactions":5848,"../../../../shared/constants/time":5852},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,s){Object.defineProperty(s,"__esModule",{value:!0}),s.controllerName=s.POLL_COUNT_LIMIT=s.MAX_GAS_LIMIT=s.FALLBACK_QUOTE_REFRESH_TIME=void 0,s.getDefaultSwapsControllerState=function(){return{swapsState:{quotes:{},quotesPollingLimitEnabled:!1,fetchParams:null,tokens:null,tradeTxId:null,approveTxId:null,quotesLastFetched:null,customMaxGas:"",customGasPrice:null,customMaxFeePerGas:null,customMaxPriorityFeePerGas:null,swapsUserFeeLevel:"",selectedAggId:null,customApproveTxData:"",errorKey:"",topAggId:null,routeState:"",swapsFeatureIsLive:!0,saveFetchedQuotes:!1,swapsQuoteRefreshTime:n,swapsQuotePrefetchingRefreshTime:n,swapsStxBatchStatusRefreshTime:a.FALLBACK_SMART_TRANSACTIONS_REFRESH_TIME,swapsStxStatusDeadline:a.FALLBACK_SMART_TRANSACTIONS_DEADLINE,swapsStxGetTransactionsRefreshTime:a.FALLBACK_SMART_TRANSACTIONS_REFRESH_TIME,swapsStxMaxFeeMultiplier:a.FALLBACK_SMART_TRANSACTIONS_MAX_FEE_MULTIPLIER,swapsFeatureFlags:{}}}};var a=e("../../../../shared/constants/smartTransactions"),r=e("../../../../shared/constants/time");s.controllerName="SwapsController",s.MAX_GAS_LIMIT=25e5,s.POLL_COUNT_LIMIT=3;const n=s.FALLBACK_QUOTE_REFRESH_TIME=r.MINUTE}}},{package:"$root$",file:"app/scripts/controllers/swaps/swaps.constants.ts"}],[97,{"./swaps.constants":96,"bignumber.js":4029},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,s){Object.defineProperty(s,"__esModule",{value:!0}),s.calculateGasEstimateWithRefund=function(e=r.MAX_GAS_LIMIT,t="0",s="0"){const n=new a.BigNumber(e,10).minus(t,10),i=n.lt(0);return!i&&n.lt(s,16)?`0x${n.toString(16)}`:s},s.getMedianEthValueQuote=function(e){if(!Array.isArray(e)||0===e.length)throw new Error("Expected non-empty array param.");const t=[...e];if(t.sort(((e,t)=>{const s=new a.BigNumber(e.overallValueOfQuote,10),r=new a.BigNumber(t.overallValueOfQuote,10);return s.equals(r)?0:s.lessThan(r)?-1:1})),t.length%2==1){const e=t[(t.length-1)/2].overallValueOfQuote;return n(t.filter((t=>e===t.overallValueOfQuote)))}const s=t.length/2,r=s-1,i=t[s].overallValueOfQuote,o=t[r].overallValueOfQuote,l=t.filter((e=>i===e.overallValueOfQuote)),u=t.filter((e=>o===e.overallValueOfQuote)),c=n(l),d=n(u);return{ethFee:new a.BigNumber(c.ethFee,10).plus(d.ethFee,10).dividedBy(2).toString(10),metaMaskFeeInEth:new a.BigNumber(c.metaMaskFeeInEth,10).plus(d.metaMaskFeeInEth,10).dividedBy(2).toString(10),ethValueOfTokens:new a.BigNumber(c.ethValueOfTokens,10).plus(d.ethValueOfTokens,10).dividedBy(2).toString(10)}},s.meansOfQuotesFeesAndValue=n;var a=e("bignumber.js"),r=e("./swaps.constants");function n(e){const t=e.reduce(((e,t)=>({ethFee:e.ethFee.plus(t.ethFee,10),metaMaskFeeInEth:e.metaMaskFeeInEth.plus(t.metaMaskFeeInEth,10),ethValueOfTokens:e.ethValueOfTokens.plus(t.ethValueOfTokens,10)})),{ethFee:new a.BigNumber(0,10),metaMaskFeeInEth:new a.BigNumber(0,10),ethValueOfTokens:new a.BigNumber(0,10)});return{ethFee:t.ethFee.div(e.length,10).toString(10),metaMaskFeeInEth:t.metaMaskFeeInEth.div(e.length,10).toString(10),ethValueOfTokens:t.ethValueOfTokens.div(e.length,10).toString(10)}}}}},{package:"$root$",file:"app/scripts/controllers/swaps/swaps.utils.ts"}],[98,{"../../shared/constants/app":5824,"./lib/util":206,"webextension-polyfill":5801},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,s){Object.defineProperty(s,"__esModule",{value:!0}),s.onMessageReceived=s.checkForMultipleVersionsRunning=void 0;var a,r=(a=e("webextension-polyfill"))&&a.__esModule?a:{default:a},n=e("../../shared/constants/app"),i=e("./lib/util");const o="isRunning";s.onMessageReceived=e=>{e===o&&console.warn("Warning! You have multiple instances of MetaMask running!")};s.checkForMultipleVersionsRunning=async()=>{if((0,i.getPlatform)()!==n.PLATFORM_CHROME&&(0,i.getPlatform)()!==n.PLATFORM_FIREFOX)return;const e=(0,i.getPlatform)()===n.PLATFORM_CHROME?n.CHROME_BUILD_IDS:n.FIREFOX_BUILD_IDS,t=r.default.runtime.id;for(const s of e)if(s!==t)try{await r.default.runtime.sendMessage(s,o)}catch(e){}}}}},{package:"$root$",file:"app/scripts/detect-multiple-instances.js"}],[99,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,s){Object.defineProperty(s,"__esModule",{value:!0}),s.default=void 0;s.default={config:{}}}}},{package:"$root$",file:"app/scripts/first-time-state.js"}],[4,{"../../shared/constants/app":5824,"../../shared/constants/metametrics":5836,"../../shared/constants/offscreen-communication":5841,"../../shared/modules/browser-runtime.utils":5903,"../../shared/modules/caip-stream":5904,"../../shared/modules/fetch-with-timeout":5910,"../../shared/modules/mv3.utils":5915,"../../shared/modules/object.utils":5917,"../../shared/modules/selectors/networks":5923,"../../test/e2e/background-socket/socket-background-to-mocha":5933,"../../test/e2e/default-fixture":5935,"../../test/stub/keyring-bridge":5941,"./constants/marketing-site-whitelist":6,"./constants/sentry-state":7,"./constants/snaps":8,"./constants/stream":9,"./first-time-state":99,"./fixtures/generate-wallet-state":100,"./lib/createStreamSink":127,"./lib/ens-ipfs/setup":134,"./lib/get-first-preferred-lang-code":136,"./lib/getObjStructure":137,"./lib/migrator":141,"./lib/notification-manager":145,"./lib/setup-initial-state-hooks":175,"./lib/state-corruption-errors":185,"./lib/stores/extension-store":187,"./lib/stores/persistence-manager":189,"./lib/stores/read-only-network-store":190,"./lib/stream-utils":191,"./lib/util":206,"./metamask-controller":207,"./migrations":395,"./offscreen":396,"./platforms/extension":397,"@metamask/notification-services-controller":2432,"@metamask/obs-store":2445,"@metamask/utils":3026,"debounce-stream":4293,events:4475,"extension-port-stream":4478,loglevel:4942,"readable-stream":5299,"webextension-polyfill":5801},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,s){Object.defineProperty(s,"__esModule",{value:!0}),s.loadStateFromPersistence=be,s.setupController=Pe,s.statePersistenceEvents=void 0,e("./lib/setup-initial-state-hooks");var a=H(e("events")),r=e("readable-stream"),n=H(e("debounce-stream")),i=H(e("loglevel")),o=H(e("webextension-polyfill")),l=e("@metamask/obs-store"),u=e("@metamask/utils"),c=H(e("extension-port-stream")),d=e("@metamask/notification-services-controller"),p=e("../../shared/constants/app"),h=e("../../shared/constants/metametrics"),m=e("../../shared/modules/browser-runtime.utils"),g=e("../../shared/modules/mv3.utils"),f=e("../../shared/modules/object.utils"),S=(e("../../test/e2e/default-fixture"),e("../../test/e2e/background-socket/socket-background-to-mocha"),e("../../shared/constants/offscreen-communication"),e("../../test/stub/keyring-bridge")),w=e("../../shared/modules/selectors/networks"),E=e("../../shared/modules/caip-stream"),T=H(e("../../shared/modules/fetch-with-timeout")),v=e("./lib/state-corruption-errors"),M=e("./lib/stores/persistence-manager"),_=H(e("./lib/stores/extension-store")),I=H(e("./lib/stores/read-only-network-store")),A=H(e("./migrations")),b=H(e("./lib/migrator")),C=H(e("./platforms/extension")),N=e("./constants/sentry-state"),R=H(e("./lib/createStreamSink")),P=j(e("./lib/notification-manager")),k=j(e("./metamask-controller")),O=H(e("./lib/get-first-preferred-lang-code")),y=H(e("./lib/getObjStructure")),F=H(e("./lib/ens-ipfs/setup")),L=e("./lib/util"),x=e("./offscreen"),G=e("./lib/stream-utils"),D=(e("./fixtures/generate-wallet-state"),H(e("./first-time-state"))),B=e("./constants/marketing-site-whitelist"),U=e("./constants/stream"),V=e("./constants/snaps");function Q(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,s=new WeakMap;return(Q=function(e){return e?s:t})(e)}function j(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var s=Q(t);if(s&&s.has(e))return s.get(e);var a={__proto__:null},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var n in e)if("default"!==n&&{}.hasOwnProperty.call(e,n)){var i=r?Object.getOwnPropertyDescriptor(e,n):null;i&&(i.get||i.set)?Object.defineProperty(a,n,i):a[n]=e[n]}return a.default=e,s&&s.set(e,a),a}function H(e){return e&&e.__esModule?e:{default:e}}const K="#0376C9",W="#D73847",q=9,Y=!1,$=Y?new I.default:new _.default,X=new M.PersistenceManager({localStore:$});global.stateHooks.getMostRecentPersistedState=()=>X.mostRecentRetrievedState,global.logEncryptedVault=()=>{X.logEncryptedVault()};const{sentry:z}=global;let J={...D.default};const Z={[p.ENVIRONMENT_TYPE_POPUP]:!0,[p.ENVIRONMENT_TYPE_NOTIFICATION]:!0,[p.ENVIRONMENT_TYPE_FULLSCREEN]:!0},ee=["trezor-connect"];i.default.setLevel("info",!1);const te=new C.default,se=new P.default,ae=(0,L.getPlatform)()===p.PLATFORM_FIREFOX;let re=0,ne=!1,ie=!1;const oe={},le={};let ue;const ce={};Y&&(global.stateHooks.metamaskGetState=X.get.bind(X));const de=new URL("https://metamask.github.io/phishing-warning/v4.1.0/"),pe=de.toString(),he=1e3,me=s.statePersistenceEvents=new a.default;if(g.isManifestV3)globalThis.stateHooks.metamaskWasJustInstalled?(ye(),delete globalThis.stateHooks.metamaskWasJustInstalled):globalThis.stateHooks.metamaskTriggerOnInstall=()=>ye();else{const e=t=>{"install"===t.reason&&(ye(),o.default.runtime.onInstalled.removeListener(e))};o.default.runtime.onInstalled.addListener(e)}const{promise:ge,resolve:fe,reject:Se}=(0,L.deferredPromise)(),we=async()=>{const e=await o.default.tabs.query({url:"<all_urls>",windowType:"normal"}).then((e=>((0,m.checkForLastErrorAndLog)(),e))).catch((()=>{(0,m.checkForLastErrorAndLog)()}));for(const t of e)o.default.tabs.sendMessage(t.id,{name:p.EXTENSION_MESSAGES.READY}).then((()=>{(0,m.checkForLastErrorAndLog)()})).catch((()=>{(0,m.checkForLastErrorAndLog)()}))};let Ee,Te,ve,Me;function _e(){const e=(new Date).toISOString();o.default.storage.session.set({timestamp:e})}async function Ie(){const e=g.isManifestV3?(0,x.createOffscreen)():null,t=await be(),s=t.data,a=await(0,O.default)();let r;if(g.isManifestV3){var n;if(!1!==(null===(n=s.PreferencesController)||void 0===n?void 0:n.enableMV3TimestampSave)){const e=2e3;_e(),setInterval(_e,e)}const e=await o.default.storage.session.get(["isFirstMetaMaskControllerSetup"]);r=(null==e?void 0:e.isFirstMetaMaskControllerSetup)===undefined,await o.default.storage.session.set({isFirstMetaMaskControllerSetup:r})}const i=Y?{keyrings:{trezorBridge:S.FakeTrezorBridge,ledgerBridge:S.FakeLedgerBridge}}:{},l=await async function(){const e=(0,T.default)(),t=V.PREINSTALLED_SNAPS_URLS.map((async t=>{const s=await e(t);if(t.pathname.endsWith(".json.gz")){const e=new DecompressionStream("gzip"),t=s.body.pipeThrough(e);return await new Response(t).json()}return await s.json()}));return Promise.all(t)}();Pe(s,a,i,r,t.meta,e,l),function(e){async function t(e,t){try{return await o.default.tabs.update(e,{url:t})}catch(e){return null==z?void 0:z.captureException(e)}}const s=!g.isManifestV3;o.default.webRequest.onBeforeRequest.addListener((a=>{var r,n,i;if(a.tabId===o.default.tabs.TAB_ID_NONE)return{};const{completedOnboarding:l}=e.onboardingController.state;if(!l)return{};if(!e.preferencesController.state.usePhishDetect)return{};if(a.initiator&&"null"!==a.initiator&&new URL(a.initiator).host===de.host)return{};const{hostname:u,href:c,searchParams:d}=new URL(a.url);if(Y&&d.has("IN_TEST_BYPASS_EARLY_PHISHING_DETECTION"))return{};e.phishingController.maybeUpdateState();const p=e.phishingController.isBlockedRequest(a.url);let m,g;if("main_frame"!==a.type&&"sub_frame"!==a.type||(m=e.phishingController.test(a.url)),!(null!==(r=m)&&void 0!==r&&r.result||p.result))return{};let f=u;null!==(n=m)&&void 0!==n&&n.result&&p.result?g=`${m.type} and ${p.type}`:null!==(i=m)&&void 0!==i&&i.result?g=m.type:(g=p.type,f=a.initiator),ae||e.metaMetricsController.trackEvent({event:h.MetaMetricsEventName.PhishingPageDisplayed,category:h.MetaMetricsEventCategory.Phishing,properties:{url:f,referrer:{url:f},reason:g,requestDomain:p.result?u:undefined}},{excludeMetaMetricsId:!0});const S=new URLSearchParams({hostname:u,href:c}),w=new URL(pe);w.hash=S.toString();const E=w.toString();return s?"main_frame"===a.type?{redirectUrl:E}:(t(a.tabId,E),{cancel:!0}):(t(a.tabId,E),{})}),{urls:["http://*/*","https://*/*","ws://*/*","wss://*/*"]},s?["blocking"]:[])}(ue),g.isManifestV3||await async function(){let e;try{const t=new URL(pe);let s,a;t.hash="#extensionStartup",e=window.document.createElement("iframe"),e.setAttribute("src",t.href),e.setAttribute("sandbox","allow-scripts allow-same-origin");const r=new Promise(((e,t)=>{s=e,a=t}));e.addEventListener("load",s),window.document.body.appendChild(e),setTimeout((()=>a(new Ae)),he),await r}catch(e){e instanceof Ae?console.warn("Phishing warning page timeout; page not guaranteed to work offline."):console.error("Failed to initialize phishing warning page",e)}finally{e&&e.remove()}}(),await we()}o.default.runtime.onConnect.addListener((async(...e)=>{try{await ge,Ee(...e)}catch(s){if(null==z||z.captureException(s),v.KNOWN_STATE_CORRUPTION_ERRORS.has(s.message)){const a=await $.get().catch((e=>null)),r=e[0];try{var t;r.postMessage({data:{method:v.METHOD_DISPLAY_STATE_CORRUPTION_ERROR,params:{error:{message:s.message,name:s.name,stack:s.stack},currentLocale:null==a||null===(t=a.data)||void 0===t||null===(t=t.PreferencesController)||void 0===t?void 0:t.currentLocale}}})}catch(e){i.default.error("MetaMask - Failed to send state corruption error",e)}}}})),o.default.runtime.onConnectExternal.addListener((async(...e)=>{await ge,Te(...e)}));class Ae extends Error{constructor(){super("Timeout failed")}}async function be(){var e,t;let s=await X.get();const a=new b.default({migrations:A.default,defaultVersion:null});a.on("error",(e=>{console.warn(e);const t=(0,y.default)(s);z.captureException(e,{extra:{vaultStructure:t}})})),null!==(e=s)&&void 0!==e&&e.data||null!==(t=s)&&void 0!==t&&t.meta||(s=a.generateInitialState(J));const r=await a.migrateData(s);if(!r)throw new Error("MetaMask - migrator returned undefined");if(!(0,u.isObject)(r.meta))throw new Error(`MetaMask - migrator metadata has invalid type '${typeof r.meta}'`);if("number"!=typeof r.meta.version)throw new Error(`MetaMask - migrator metadata version has invalid type '${typeof r.meta.version}'`);if(!(0,u.isObject)(r.data))throw new Error(`MetaMask - migrator data has invalid type '${typeof r.data}'`);return X.setMetadata(r.meta),await X.set(r.data),r}function Ce(e){const{metaMetricsId:t}=ue.metaMetricsController.state;if(!(0,L.shouldEmitDappViewedEvent)(t))return;const s=ue.getPermittedAccounts(e).length;if(0===s)return;const a=ue.controllerMessenger.call("PreferencesController:getState"),r=Object.keys(a.identities).length;ue.metaMetricsController.trackEvent({event:h.MetaMetricsEventName.DappViewed,category:h.MetaMetricsEventCategory.InpageProvider,referrer:{url:e},properties:{is_first_visit:!1,number_of_accounts:r,number_of_accounts_connected:s}},{excludeMetaMetricsId:!0})}function Ne(e){if(!e.sender||!e.sender.tab||!e.sender.url)return;const t=e.sender.tab.id,s=new URL(e.sender.url),{origin:a}=s;Object.keys(ce).includes(t)||(ce[t]=a);const r=ue.controllerMessenger.call("PermissionController:hasPermissions",a),n="New Tab"!==e.sender.tab.title;r&&n&&Ce(a)}function Re(e){const t=[p.ENVIRONMENT_TYPE_POPUP,p.ENVIRONMENT_TYPE_NOTIFICATION,p.ENVIRONMENT_TYPE_FULLSCREEN];!(Object.values(oe).some(Boolean)||ne||re>0)&&t.includes(e)&&function(){const{metaMetricsId:e,participateInMetaMetrics:t}=ue.metaMetricsController.state;(null!==e||t)&&ue.metaMetricsController.trackEvent({event:h.MetaMetricsEventName.AppOpened,category:h.MetaMetricsEventCategory.App})}()}function Pe(e,t,s,a,u,m,S){var T;ue=new k.default({infuraProjectId:"b6bf7d3508c941499b10025c0776eaf8",showUserConfirmation:ke,initState:e,initLangCode:t,platform:te,notificationManager:se,browser:o.default,getRequestAccountTabIds:()=>le,getOpenMetamaskTabsIds:()=>oe,overrides:s,isFirstMetaMaskControllerSetup:a,currentMigrationVersion:u.version,featureFlags:{},offscreenPromise:m,preinstalledSnaps:S}),(0,F.default)({getCurrentChainId:()=>(0,w.getCurrentChainId)({metamask:ue.networkController.state}),getIpfsGateway:ue.preferencesController.getIpfsGateway.bind(ue.preferencesController),getUseAddressBarEnsResolution:()=>ue.preferencesController.state.useAddressBarEnsResolution,provider:ue.provider}),(0,r.pipeline)((0,l.storeAsStream)(ue.store),(0,n.default)(1e3),(0,R.default)((async e=>{await X.set(e),me.emit("state-persisted",e)})),(e=>{i.default.error("MetaMask - Persistence pipeline failed",e)})),T=ue,global.stateHooks.getSentryAppState=function(){const e=T.memStore.getState();return(0,f.maskObject)(e,N.SENTRY_BACKGROUND_STATE)};const v=()=>re>0||Boolean(Object.keys(oe).length)||ne,M=(e,t)=>{if(!1===e)ue.onClientClosed();else{if(t===p.ENVIRONMENT_TYPE_FULLSCREEN&&Boolean(Object.keys(oe).length))return;ue.onEnvironmentTypeClosed(t)}};function _(e,t){return e>t?`${t}+`:String(e)}function I(){const e=A(),t=function(){try{const{isNotificationServicesEnabled:e,isFeatureAnnouncementsEnabled:t}=ue.notificationServicesController.state,s=Object.values(ue.notificationServicesController.state.metamaskNotificationsList).filter((e=>e.type===d.NotificationServicesController.Constants.TRIGGER_TYPES.SNAP&&null===e.readDate)).length,a=t?ue.notificationServicesController.state.metamaskNotificationsList.filter((e=>!e.isRead&&e.type===d.NotificationServicesController.Constants.TRIGGER_TYPES.FEATURES_ANNOUNCEMENT)).length:0,r=e?ue.notificationServicesController.state.metamaskNotificationsList.filter((e=>!e.isRead&&e.type!==d.NotificationServicesController.Constants.TRIGGER_TYPES.FEATURES_ANNOUNCEMENT&&e.type!==d.NotificationServicesController.Constants.TRIGGER_TYPES.SNAP)).length:0;return s+a+r}catch(e){return console.error("Failed to get unread notifications count:",e),0}}();let s="",a=K;e?s=_(e,q):t>0&&(s=_(t,q),a=W);try{const e={text:s},t={color:a};g.isManifestV3?(o.default.action.setBadgeText(e),o.default.action.setBadgeBackgroundColor(t)):(o.default.browserAction.setBadgeText(e),o.default.browserAction.setBadgeBackgroundColor(t))}catch(e){console.error("Error updating browser badge:",e)}}function A(){try{return ue.appStateController.waitingForUnlock.length+ue.approvalController.getTotalApprovalCount()}catch(e){return console.error("Failed to get pending approval count:",e),0}}Ee=e=>{var t;const a=e.name;if(ee.includes(e.name))return;let n=!1;const l=null!==(t=e.sender)&&void 0!==t&&t.url?new URL(e.sender.url):null;if(n=ae?Z[a]:(null==l?void 0:l.origin)===`chrome-extension://${o.default.runtime.id}`,n){var u;const t=(null==s||null===(u=s.getPortStream)||void 0===u?void 0:u.call(s,e))||new c.default(e);if(ue.isClientOpen=!0,ue.setupTrustedCommunication(t,e.sender),Re(a),async function(){try{await ue.remoteFeatureFlagController.updateRemoteFeatureFlags()}catch(e){i.default.error("Error initializing remote feature flags:",e)}}(),a===p.ENVIRONMENT_TYPE_POPUP&&(re+=1,(0,r.finished)(t,(()=>{re-=1;const e=v();ue.isClientOpen=e,M(e,p.ENVIRONMENT_TYPE_POPUP)}))),a===p.ENVIRONMENT_TYPE_NOTIFICATION&&(ne=!0,(0,r.finished)(t,(()=>{ne=!1;const e=v();ue.isClientOpen=e,M(e,p.ENVIRONMENT_TYPE_NOTIFICATION)}))),a===p.ENVIRONMENT_TYPE_FULLSCREEN){const s=e.sender.tab.id;oe[s]=!0,(0,r.finished)(t,(()=>{delete oe[s];const e=v();ue.isClientOpen=e,M(e,p.ENVIRONMENT_TYPE_FULLSCREEN)}))}}else if(l&&l.origin===de.origin&&l.pathname===de.pathname){var d;const t=(null==s||null===(d=s.getPortStream)||void 0===d?void 0:d.call(s,e))||new c.default(e);ue.setupPhishingCommunication({connectionStream:t})}else{var h;if(e.sender&&e.sender.tab&&e.sender.url){const t=e.sender.tab.id,s=new URL(e.sender.url),{origin:a}=s;Ne(e),e.onMessage.addListener((e=>{e.data&&e.data.method===p.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS&&(le[a]=t)}))}if(l&&B.COOKIE_ID_MARKETING_WHITELIST_ORIGINS.some((e=>e===l.origin))){var m;const t=(null==s||null===(m=s.getPortStream)||void 0===m?void 0:m.call(s,e))||new c.default(e);ue.setUpCookieHandlerCommunication({connectionStream:t})}const t=(null==s||null===(h=s.getPortStream)||void 0===h?void 0:h.call(s,e))||new c.default(e);if(ve(t,e.sender),ae){const s=(0,G.setupMultiplex)(t);s.ignoreStream(U.METAMASK_EIP_1193_PROVIDER),Me(s.createStream(U.METAMASK_CAIP_MULTICHAIN_PROVIDER),e.sender)}}},Te=e=>{var t;const a=(null==s||null===(t=s.getPortStream)||void 0===t?void 0:t.call(s,e))||new c.default(e);if(!e.sender.id){if(ee.includes(e.name))return;Ne(e),Me((0,E.createCaipStream)(a),e.sender)}else ve(a,e.sender)},ve=(e,t)=>{ue.setupUntrustedCommunicationEip1193({connectionStream:e,sender:t})},Me=(e,t)=>{ue.setupUntrustedCommunicationCaip({connectionStream:e,sender:t})},null!=s&&s.registerConnectListeners&&s.registerConnectListeners(Ee,ve),I(),ue.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.DECRYPT_MESSAGE_MANAGER_UPDATE_BADGE,I),ue.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.ENCRYPTION_PUBLIC_KEY_MANAGER_UPDATE_BADGE,I),ue.signatureController.hub.on(k.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,I),ue.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.APP_STATE_UNLOCK_CHANGE,I),ue.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.APPROVAL_STATE_CHANGE,I),ue.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.METAMASK_NOTIFICATIONS_LIST_UPDATED,I),ue.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.METAMASK_NOTIFICATIONS_MARK_AS_READ,I),se.on(P.NOTIFICATION_MANAGER_EVENTS.POPUP_CLOSED,(({automaticallyClosed:e})=>{e?A()>0&&ke():(ue.signatureController.rejectUnapproved(h.REJECT_NOTIFICATION_CLOSE_SIG),ue.decryptMessageController.rejectUnapproved(h.REJECT_NOTIFICATION_CLOSE),ue.encryptionPublicKeyController.rejectUnapproved(h.REJECT_NOTIFICATION_CLOSE),ue.rejectAllPendingApprovals()),I()})),Object.values(ue.snapController.state.snaps).some((e=>!e.preinstalled))&&ue.snapController.updateBlockedSnaps()}async function ke(){const e=await te.getActiveTabs(),t=Boolean(e.find((e=>oe[e.id]))),s=e.length>0&&e[0].extData&&e[0].extData.indexOf("vivaldi_tab")>-1;if(!ie&&(s||0===re)&&!t){ie=!0;try{const e=ue.appStateController.getCurrentPopupId();await se.showPopup((e=>ue.appStateController.setCurrentPopupId(e)),e)}finally{ie=!1}}}const Oe=()=>{if(ue)return ue.metaMetricsController.updateTraits({[h.MetaMetricsUserTrait.InstallDateExt]:(new Date).toISOString().split("T")[0]}),void ue.metaMetricsController.addEventBeforeMetricsOptIn({category:h.MetaMetricsEventCategory.App,event:h.MetaMetricsEventName.AppInstalled,properties:{}});setTimeout((()=>{Oe()}),500)};function ye(){i.default.debug("First install detected"),Oe(),te.openExtensionInBrowser()}(async function(){o.default.tabs.onActivated.addListener((e=>{if(ue){const{tabId:t}=e,s=ce[t];s&&ue.permissionController.state.subjects[s]!==undefined&&Ce(s)}}));try{await Ie(),X.cleanUpMostRecentRetrievedState(),i.default.info("MetaMask initialization complete."),fe()}catch(e){i.default.error(e),Se(e)}})()}}},{package:"$root$",file:"app/scripts/background.js"}]],[4],{});